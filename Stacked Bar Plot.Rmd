<<<<<<< HEAD
---
title: "Wastewater, Model Work"
author: "`Marlin derived from work by Brian Yandell"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.height = 2,
	fig.width = 3,
	message = FALSE,
	warning = FALSE
)
```

```
The code was derived from work by the DSI. This analysis seeks to model % of tests positive using wastewater Data. This model has logical reasons to be predictive but only finds moderate success when broken down by collection site. Particularly it consistently underpredicts the % positive rate in the P2 district.
The Original R code file can be found in the [pandemic github repository](https://github.com/UW-Madison-DataScience/pandemic/blob/master/wastewater.Rmd).
The Code for this R File can be found in the [Marlin Lee waste Water Work](https://github.com/MarlinRLee/Covid-Waste-Water-Exploration/blob/main/general%20model%20finding.Rmd)
```




```{r}
library(tidyverse)
library(readxl)
library(broom)
library(zoo)
library(RcppRoll)
library(ggformula)
library(ggpubr)
kprint <- function(...) {
  if(interactive()) {
    print(...)
  } else {
    knitr::kable(...)
  }
}
```

```{r 2}
filename <- "data/Interceptor_MassBalance_Analysis_02232021.xlsx"

```

```{r warning = FALSE, message = FALSE}

missing_codes <- c("","NA","0","Undetected","Not Detected",
                   "Field Parameters to be filled in", 
                   "Inhibited-to be re-ran", "#DIV/0!")
DataFrame <- read_excel(filename,trim_ws=T,col_names=TRUE)%>%
  select(Date:"P18 FLOW")%>%
  pivot_longer("MC BCoV":"P18 BCoV",names_to = "Site",values_to = "BCoV")%>%
  pivot_longer("MC SC2":"P18 SC2",names_to = "Site2",values_to = "SC2")%>%
  pivot_longer("MC PMMoV":"P18 PMMoV",names_to = "Site3",values_to = "PMMoV")%>%
  pivot_longer("MC FLOW":"P18 FLOW",names_to = "Site4",values_to = "FLOW")%>%
  mutate(Site=substr(Site, start = 1, stop = 3),Site2=substr(Site2, start = 1, stop = 3),Site3=substr(Site3, start = 1, stop = 3),Site4=substr(Site4, start = 1, stop = 3))%>%
  filter(Site==Site2,Site2==Site3,Site3==Site4)%>%
  select(-Site2,-Site3,-Site4)%>%
  mutate(SC2Mass=3.785*1000000*SC2*FLOW , PMMoVMass=3.785*1000000*PMMoV*FLOW)%>%
  mutate(Date=as.character(Date))
```

```{r, echo=FALSE, dpi=600, fig.width=12, fig.height=12}
SumInter=DataFrame%>%
  filter(Site!="MC ")%>%
  group_by(Date)%>%
  summarize(sumSC2=sum(SC2Mass),sumPMMoV=sum(PMMoVMass))
MadMass=DataFrame%>%
  filter(Site=="MC ")%>%
  select(Date,SC2Mass,PMMoVMass)

sumar=inner_join(SumInter,MadMass,by = c("Date"))

DataFrame=DataFrame%>%
  filter(Site!="MC ")


ggplot() + 
  geom_bar(data=DataFrame, aes(fill=Site, y=SC2Mass, x=Date),position="stack", stat="identity")+
  geom_errorbar(data=MadMass,aes(x=Date,ymin = 0, ymax = SC2Mass))+
  geom_point(data=MadMass,aes(x=Date,y=SC2Mass),color="aquamarine1",size=2)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle("SARS-CoV-2, 24-hr Mass Loading, MMSD, (gene copies per day)")+
  ylab("Gene copies per Day")

ggplot() + 
  geom_bar(data=DataFrame, aes(fill=Site, y=PMMoVMass, x=Date),position="stack", stat="identity")+
  geom_errorbar(data=MadMass,aes(x=Date,ymin = 0, ymax = PMMoVMass))+
  geom_point(data=MadMass,aes(x=Date,y=PMMoVMass),color="aquamarine1",size=2)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle("PMMoV, 24-hr Mass Loading, MMSD, (gene copies per day)")+
  ylab("Gene copies per Day")
```
